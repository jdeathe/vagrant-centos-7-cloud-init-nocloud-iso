#cloud-config

---
timezone: "UTC"
write_files:
  - path: "/etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7"
    permissions: "0600"
    owner: "root:root"
    encoding: "gz+b64"
    content: "H4sICHtLh10CA2VwZWwtNy50eHQAdVW3rvPqAdv1FGdMYNxrWdUK8A+feu99U7eq1dvT35PsIcCJBBcS4F9//YLmBEn/MQXzx/RoVWJ+FC76oVWDUf6r/gX5xbzU3+E/P8KwmcLP/vob+/v1+vmXoHtPtR62898Q1FuSTvPKlkgWzQHm5Y2f8NAmBiSz6YnPeDH4pUvSwvUNZGRbPBoMiigfcxXT5AlmGjKcwmpJmoLryZHf+DMjEQMMmBFGu0ugVckU4SgvuEYWfdiai24FgdNsFNUFDzA5eg81UfDp7U61hQ42DLKSjoYkiVwK90zT+e52zAaGdeQEU6OlTTf4yIAkKeDwaiL8cTKhnQ/9q5z95Lkl3bdi/b4kPsiK2flYl9N7csVF5D30HJn74RLPXAgUwcKQ2CrdRB1YDWrcL1j6CAZXsbdSGhJ17K+3sCdDNJpZEGAhbLNmNk4lr8ctgaGnhHVL/IgQbqaiDYec5/uEu+ux9r30bRMOPo409zYSgyM3bphimb9RUNsVfm8WcpbKKX99nHtwn8caHQIrQwMhlsHHroYtt+1j32QMv9fIX5WtU463ZY054rjBnFkWKyd20A/a9xs+TeC6DUNzJw1ReXujb3be9paUWlFbF2nqWmBYWr6Erxx1vztBc0jINpIA3/yp5psspP6RPYlZyigccmEcb1CCu2Fxbs58dAXDEE970hS8p8qOT5PzXNnBIQ+SDKY7IMWGn1nYL9wT2YemgYQp+4icNZbsyBt3+lZd/lNFdX7Zuld2VoTigWrcqu4/Rh8tLFSuXi+PP4rO0dWptEpo420he9zZ0eqN+MEvc++pb26/aKmcZGJRBFNIV1MPvyRna/Y1Bpd9w3cNrwewgQVoaGU+QhzYe9Zzle3TvMuAr361lSn4RxycIO79NkXlTybKe9L7Tc7gv97sUVsSRtMaDYEK1LQlO3Nfc+CzmHS1yAzIWFBFPgMkmakWjq8kFlhS8cuwAkBhbHpSCaLWnbOF8KwU2Ce2jNO4uM3KauQ0Xquiisq8xeu+BfW04na5u9RxUILn8VqMxbEQYoMXVhg1QfXJqskV2O88F54L3l5GjTLwFj6JeriT6LKrB/0h4XSeFE95YfyLnmezRqgiUUrhIWyQxq9hTgtIQhqr2R/otSn9RHHjb/twbxIcrjj57tjOJAerkAHisJ3nwd6hzOniiM8FRElLjzLRlY8XLKg2wI8vVpo0vqm591E5j90/iKI8n6XWNAn6hdWHo99vHU7Y+BpwcEKMR9k0yomZW2R89b3wrbcbiqLjuUjtl248sIqe610q853FSlkvdVoMj48jUoARGH2HxCH0G9HiqVoMwKi0tlR83vyMDHi+ljLHkw4XvoU0JPl0Cb4I1Yba7Ff6JOoXO5S/O/C/5pZWVr7Ksdz6MWgTcda2N7jWwyUQCyv0qZelVxKksaVLeBNEU0bYysYoxJOnfltYP7xLVbLxIh+XvamEtyPPvbp9+2UL+eGrytF5jWCCJiq7kbGOQAPAOeud2swrMsUM4mZnTm0BPhqpBDa6b8vLcIwTPWMxHkO+7C13YU3yN9FQb59626h88OCUsec5FYaOQTtj8h5hLC7aBdb7IOsO/34iCj/6rSlnomvfVMvdcm64dzaQLJ1684aijKUJSoxy+wrZzcKQPJuq8IucTucR++ApCu1V1huWjZX/9r0hnTq8APHjpXYEe/z5A/355GYC/e87OJ39/8fyDyB7Elx9BgAA"
  - path: "/etc/yum/pluginconf.d/fastestmirror.conf"
    permissions: "0644"
    owner: "root:root"
    content: |
      [main]
      enabled=0
      verbose=0
      always_print_best_host = true
      socket_timeout=3
      hostfilepath=timedhosts.txt
      maxhostfileage=10
      maxthreads=15
yum_repos:
  epel:
    name: "Extra Packages for Enterprise Linux 7 - $basearch"
    baseurl: "http://download.fedoraproject.org/pub/epel/7/$basearch"
    metalink: "https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch"
    failovermethod: "priority"
    enabled: true
    gpgcheck: true
    gpgkey: "file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7"
packages:
  - chrony
  - docker-compose
  - docker-latest
  - etcd
  - iptables-services
  - yum-plugin-ovl
runcmd:
  - [ sed, -r, -i, -e, 's~^(makestep )[0-9\.]+ (-)?[0-9]+$~\11 -1~', /etc/chrony.conf ]
  - [ systemctl, disable, --force, --now, firewalld.service ]
  - [ systemctl, mask, --no-block, firewalld.service ]
  - [ sed, -i, '/DOCKERBINARY=\/usr\/bin\/docker-latest/s~^#~~g', /etc/sysconfig/docker ]
  - [ sed, -i, "s~OPTIONS='--selinux-enabled\\(.*\\)'~OPTIONS='--selinux-enabled=false\\1'~", /etc/sysconfig/docker, /etc/sysconfig/docker-latest ]
  - [ sed, -i, '/STORAGE_DRIVER=.*$/ { $!N; d; }', /etc/sysconfig/docker-latest-storage-setup ]
  - [ /bin/bash, -c, "echo 'STORAGE_DRIVER=overlay' >> /etc/sysconfig/docker-latest-storage-setup" ]
  - [ systemctl, enable, --force, --now, --no-block, docker-latest.service ]
  - [ systemctl, mask, --no-block, docker.service ]
  - [ systemctl, enable, --force, --now, --no-block, etcd.service ]
  - [ timedatectl, set-ntp, false ]
  - [ timedatectl, set-ntp, true ]
